<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Pro Runner - MZK Neon Edition</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; touch-action: none; }
        #ui {
            position: absolute; top: 10px; left: 10px; color: #0f0;
            background: rgba(0,0,0,0.8); padding: 10px; border: 2px solid #0f0;
            border-radius: 12px; pointer-events: none; z-index: 10; font-size: 14px;
        }
        #user-photo {
            position: absolute; top: 10px; right: 10px;
            width: 60px; height: 60px;
            border: 2px solid #00d2ff; border-radius: 50%;
            background: #222; overflow: hidden; z-index: 15;
        }
        #user-photo img { width: 100%; height: 100%; object-fit: cover; }
        #countdown {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 120px; color: #fff; font-weight: bold; z-index: 200;
            text-shadow: 0 0 20px #0f0; display: none;
        }
        #alert-msg {
            position: absolute; top: 25%; left: 50%; transform: translate(-50%, -50%);
            color: #ffcc00; font-size: 24px; font-weight: bold; display: none;
            text-shadow: 0 0 15px #ffcc00; z-index: 20; text-align: center;
            background: rgba(0,0,0,0.5); padding: 10px; border-radius: 10px;
        }
        #controls {
            position: absolute; bottom: 30px; width: 100%;
            display: flex; justify-content: space-between; padding: 0 20px;
            box-sizing: border-box; z-index: 30;
        }
        .btn-move {
            width: 75px; height: 75px; background: rgba(255, 255, 255, 0.2);
            border: 2px solid #fff; border-radius: 50%; color: white;
            font-size: 35px; display: flex; align-items: center; justify-content: center;
            -webkit-user-select: none;
            user-select: none;
        }
        #game-over {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: white; background: rgba(255, 0, 0, 0.9); padding: 30px; display: none;
            text-align: center; border-radius: 20px; z-index: 100; border: 5px solid white; width: 80%;
        }
        button { padding: 12px 35px; cursor: pointer; font-weight: bold; border-radius: 8px; border: none; font-size: 18px; }
    </style>
</head>
<body>

<div id="countdown"></div>
<div id="alert-msg">üö® ÿÆÿ∑ÿ±! ÿßŸÑŸàÿ≠ÿ¥ ŸÇÿßÿØŸÖ! üö®</div>

<div id="user-photo">
    <img src="" alt="MZK" id="profile-img" onerror="this.src='https://via.placeholder.com/60?text=MZK'">
</div>

<div id="ui">
    <div>‚ù§Ô∏è ÿßŸÑÿ£ÿ±Ÿàÿßÿ≠: <span id="lives">3</span></div>
    <div>üèÜ ÿßŸÑŸÜŸÇÿ∑: <span id="score">0</span></div>
    <div>‚ö° ÿßŸÑÿ≥ÿ±ÿπÿ©: <span id="speed-val">0.15</span></div>
</div>

<div id="controls">
    <div class="btn-move" id="leftBtn">‚óÄ</div>
    <div class="btn-move" id="rightBtn">‚ñ∂</div>
</div>

<div id="game-over">
    <h1>GAME OVER</h1>
    <p id="final-score"></p>
    <button onclick="location.reload()">ÿ•ÿπÿßÿØÿ© ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ©</button>
</div>

<script type="importmap">
    { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
</script>

<script type="module">
    import * as THREE from 'three';

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playSound(freq, duration, type = 'sine', volume = 0.1) {
        try {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const o = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            o.type = type; o.connect(g); g.connect(audioCtx.destination);
            o.frequency.value = freq;
            g.gain.setValueAtTime(volume, audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + duration);
            o.start(); o.stop(audioCtx.currentTime + duration);
        } catch(e) {}
    }

    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x050505);
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ antialias: true, preserveDrawingBuffer: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);
    scene.add(new THREE.AmbientLight(0xffffff, 0.7));
    const spotlight = new THREE.PointLight(0x00ff00, 25, 50);
    scene.add(spotlight);

    const floorMaterial = new THREE.MeshStandardMaterial({ color: 0x151515 });
    const floor = new THREE.Mesh(new THREE.PlaneGeometry(12, 30000), floorMaterial);
    floor.rotation.x = -Math.PI / 2; floor.position.z = -15000;
    scene.add(floor);

    const player = new THREE.Mesh(new THREE.SphereGeometry(0.5, 32, 32), new THREE.MeshStandardMaterial({ color: 0x00ff00, emissive: 0x00ff00 }));
    player.position.y = 0.5; scene.add(player);

    let lives = 3, score = 0, speed = 0.15, gameActive = false, screenshotDone = false, lastBeepScore = 0, alertShown = false, levelChanged = false;
    const obstacles = [], hearts = [], monsters = [], keys = {}, move = { left: false, right: false };

    function takeScreenshot() {
        playSound(1500, 0.5, 'square', 0.2);
        if (navigator.vibrate) navigator.vibrate(250);
        const dataURL = renderer.domElement.toDataURL("image/png");
        const link = document.createElement('a');
        link.download = "MZK_Champion_" + score + ".png";
        link.href = dataURL;
        link.click();
    }

    async function startCountdown() {
        const countEl = document.getElementById('countdown');
        countEl.style.display = 'block';
        for (let i = 3; i > 0; i--) {
            countEl.innerText = i;
            playSound(440, 0.2, 'sine', 0.2);
            await new Promise(r => setTimeout(r, 1000));
        }
        countEl.innerText = "GO!";
        playSound(880, 0.5, 'sine', 0.3);
        await new Promise(r => setTimeout(r, 500));
        countEl.style.display = 'none';
        gameActive = true;
    }

    const leftBtn = document.getElementById('leftBtn');
    const rightBtn = document.getElementById('rightBtn');
    leftBtn.onpointerdown = () => move.left = true;
    leftBtn.onpointerup = () => move.left = false;
    rightBtn.onpointerdown = () => move.right = true;
    rightBtn.onpointerup = () => move.right = false;
    window.onkeydown = (e) => keys[e.code] = true;
    window.onkeyup = (e) => keys[e.code] = false;

    function update() {
        if (!gameActive) return;

        speed = 0.15 + (Math.floor(score / 100) * 0.05);
        player.position.z -= speed;
        score = Math.floor(Math.abs(player.position.z));
        document.getElementById('score').innerText = score;
        document.getElementById('speed-val').innerText = speed.toFixed(2);

        // ŸÖŸäÿ≤ÿ© ÿ™ÿ®ÿØŸäŸÑ ÿßŸÑÿ£ŸÑŸàÿßŸÜ ŸÅŸä ÿ≥ŸÉŸàÿ± 1000
        if (score >= 1000 && !levelChanged) {
            levelChanged = true;
            scene.background = new THREE.Color(0x001a1a); // ÿ≥ŸÖÿß ÿ≤ÿ±ŸÇÿßÿ° ÿ∫ÿßŸÖŸÇÿ©
            floorMaterial.color.set(0x003333); // ÿ£ÿ±ÿ∂Ÿäÿ© ŸÜŸäŸàŸÜ
            playSound(600, 1, 'triangle', 0.2); // ÿµŸàÿ™ ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑŸÑŸäŸÅŸÑ
        }

        if (score > 0 && score % 100 === 0 && score !== lastBeepScore) {
            playSound(880, 0.1);
            lastBeepScore = score;
        }

        if (score >= 3000 && !screenshotDone) {
            screenshotDone = true;
            takeScreenshot();
        }

        camera.position.set(player.position.x, 4, player.position.z + 8);
        camera.lookAt(player.position.x, 1, player.position.z - 5);
        spotlight.position.set(player.position.x, 4, player.position.z);

        if ((keys['ArrowLeft'] || move.left) && player.position.x > -5) player.position.x -= 0.22;
        if ((keys['ArrowRight'] || move.right) && player.position.x < 5) player.position.x += 0.22;

        if (Math.random() < 0.05) {
            const obs = new THREE.Mesh(new THREE.BoxGeometry(1.2, 1.2, 1.2), new THREE.MeshStandardMaterial({ color: 0xffffff }));
            obs.position.set((Math.random() - 0.5) * 10, 0.6, player.position.z - 70);
            scene.add(obs); obstacles.push(obs);
        }
        if (Math.random() < 0.006) {
            const heart = new THREE.Mesh(new THREE.TorusGeometry(0.3, 0.15), new THREE.MeshStandardMaterial({ color: 0xff00ff }));
            heart.position.set((Math.random() - 0.5) * 10, 0.8, player.position.z - 80);
            scene.add(heart); hearts.push(heart);
        }

        if (score >= 500 && !alertShown) {
            alertShown = true;
            document.getElementById('alert-msg').style.display = 'block';
            playSound(150, 1, 'sawtooth', 0.3);
            setTimeout(() => { document.getElementById('alert-msg').style.display = 'none'; }, 3000);

            const monster = new THREE.Mesh(new THREE.BoxGeometry(3, 3, 3), new THREE.MeshStandardMaterial({ color: 0xff0000, emissive: 0x330000 }));
            monster.position.set(0, 1.5, player.position.z - 120);
            scene.add(monster); monsters.push(monster);
        }

        obstacles.forEach((obs, i) => {
            if (player.position.distanceTo(obs.position) < 1) {
                lives--; document.getElementById('lives').innerText = lives;
                playSound(200, 0.3, 'square'); scene.remove(obs); obstacles.splice(i, 1);
                if (lives <= 0) { gameActive = false; document.getElementById('game-over').style.display = 'block'; document.getElementById('final-score').innerText = "ÿ≥ŸÉŸàÿ±ŸÉ: " + score;}
            }
        });

        hearts.forEach((h, i) => {
            h.rotation.y += 0.05;
            if (player.position.distanceTo(h.position) < 1) {
                lives++; document.getElementById('lives').innerText = lives;
                playSound(1200, 0.2, 'triangle'); scene.remove(h); hearts.splice(i, 1);
            }
        });

        monsters.forEach((m) => {
            m.position.z += speed * 0.8;
            if (player.position.distanceTo(m.position) < 2) {
                lives = 0; gameActive = false;
                playSound(100, 0.8, 'sawtooth');
                document.getElementById('game-over').style.display = 'block';
            }
        });
    }

    function animate() { requestAnimationFrame(animate); update(); renderer.render(scene, camera); }

    window.addEventListener('click', () => {
        if (!gameActive && score === 0) startCountdown().then(() => animate());
    }, { once: true });
</script>
</body>
</html>